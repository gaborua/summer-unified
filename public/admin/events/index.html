<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Eventos - Summer Unified</title>
    <!-- Estilos Globales -->
    <link rel="stylesheet" href="/shared/css/variables.css">
    <link rel="stylesheet" href="/shared/css/global.css">
    <script src="/shared/js/api-client.js"></script>
    <style>
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
        }

        .event-card,
        .package-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .tag {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            font-size: 0.8rem;
            margin-right: 0.4rem;
            background: var(--primary-light);
            color: var(--primary);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-area">
                    <h1>üéâ Gesti√≥n de Eventos</h1>
                </div>
                <div class="user-area">
                    <a href="/dashboard/main.html" class="btn btn-secondary">‚Üê Volver al Dashboard</a>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="admin-grid">
                <!-- Columna 1: Crear Paquetes (Eventos Madre) -->
                <section>
                    <div class="card">
                        <div class="section-header">
                            <h2>1. Evento Madre (Paquete)</h2>
                            <span class="tag">Paso 1</span>
                        </div>
                        <p class="text-sm text-gray">Crea primero el evento principal ("Paquete").</p>

                        <form id="packageForm" class="mt-4">
                            <div class="form-group">
                                <label>Nombre del Evento Madre</label>
                                <input type="text" name="package_name" required placeholder="Ej: A√±o Nuevo 2026">
                            </div>
                            <div class="form-group">
                                <label>Precio Global (Bs)</label>
                                <input type="number" name="package_price" required placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label>Descuento Global (%)</label>
                                <input type="number" name="discount_percent" value="0" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>Descripci√≥n</label>
                                <textarea name="description" rows="2" placeholder="Detalles del paquete..."></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary w-full">Crear Evento Madre</button>
                        </form>
                    </div>

                    <div class="mt-8">
                        <h3>Eventos Madre Activos</h3>
                        <div id="packagesList" class="mt-4">
                            <!-- Lista de paquetes -->
                            <p class="text-gray text-sm">Cargando...</p>
                        </div>
                    </div>
                </section>

                <!-- Columna 2: Crear Eventos Individuales -->
                <section>
                    <div class="card">
                        <div class="section-header">
                            <h2>2. Evento Individual</h2>
                            <span class="tag">Paso 2</span>
                        </div>
                        <p class="text-sm text-gray">Crea eventos y as√≠gnalos a un Evento Madre.</p>

                        <form id="eventForm" class="mt-4">
                            <div class="form-group">
                                <label>Pertenece a Evento Madre:</label>
                                <select name="package_id" id="packageSelect" required>
                                    <option value="">-- Seleccionar --</option>
                                    <!-- Se llenar√° din√°micamente -->
                                </select>
                            </div>

                            <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid var(--border-color);">

                            <div class="form-group">
                                <label>Nombre del Evento</label>
                                <input type="text" name="event_name" required placeholder="Ej: Welcome Party">
                            </div>
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" name="event_date" required>
                            </div>
                            <div class="form-group">
                                <label>Ciudad</label>
                                <select name="city" required>
                                    <option value="Tarija">Tarija</option>
                                    <option value="Santa Cruz">Santa Cruz</option>
                                    <option value="Cochabamba">Cochabamba</option>
                                    <option value="La Paz">La Paz</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Precio Individual (Ref)</label>
                                <input type="number" name="base_price" placeholder="0.00">
                            </div>

                            <button type="submit" class="btn btn-secondary w-full">Crear Y Asignar</button>
                        </form>
                    </div>

                    <div class="mt-8">
                        <h3>Eventos Individuales</h3>
                        <div id="eventsList" class="mt-4">
                            <!-- Lista de eventos -->
                            <p class="text-gray text-sm">Cargando...</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        const api = new APIClient();

        // Elementos DOM
        const eventsList = document.getElementById('eventsList');
        const packagesList = document.getElementById('packagesList');
        const packageSelect = document.getElementById('packageSelect');

        // Cargar datos al inicio
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();

            document.getElementById('packageForm').addEventListener('submit', handlePackageSubmit);
            document.getElementById('eventForm').addEventListener('submit', handleEventSubmit);
        });

        async function loadInitialData() {
            await Promise.all([loadPackages(), loadEvents()]);
        }

        // ==========================================
        // CARGAR DATOS
        // ==========================================
        async function loadEvents() {
            try {
                // Obtener eventos (podemos filtrar por activos si queremos)
                const result = await api.get('/events?active=true');
                const events = Array.isArray(result) ? result : [];
                renderEventsList(events);
            } catch (error) {
                console.error('Error loading events:', error);
                eventsList.innerHTML = '<p class="text-error">Error cargando eventos</p>';
            }
        }

        async function loadPackages() {
            try {
                // Pedimos incluir inactivos si quisi√©ramos mostrarlos, pero para el select queremos activos
                const packages = await api.get('/packages'); // default is active only
                renderPackagesList(packages);
                renderPackageSelect(packages);
            } catch (error) {
                console.error('Error loading packages:', error);
            }
        }

        // ==========================================
        // RENDERIZADO
        // ==========================================
        function renderPackageSelect(packages) {
            if (!packages || packages.length === 0) {
                packageSelect.innerHTML = '<option value="">No hay Eventos Madre activos</option>';
                return;
            }

            const options = packages.map(p => `<option value="${p.id}">${p.package_name}</option>`).join('');
            packageSelect.innerHTML = '<option value="">-- Seleccionar --</option>' + options;
        }

        function renderEventsList(events) {
            if (!events || events.length === 0) {
                eventsList.innerHTML = '<p class="text-sm">No hay eventos individuales.</p>';
                return;
            }

            eventsList.innerHTML = events.map(event => {
                // Extract parent package name if exists
                let parentPackage = 'Sin asignar';
                if (event.package_events && event.package_events.length > 0 && event.package_events[0].packages) {
                    parentPackage = event.package_events[0].packages.package_name;
                }

                return `
                <div class="event-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4>${event.event_name}</h4>
                            <p class="text-sm text-gray">
                                üìÖ ${new Date(event.event_date).toLocaleDateString()} | üìç ${event.city}
                            </p>
                            <p class="text-xs mt-1" style="color: var(--primary);">
                                üì¶ Evento Madre: <strong>${parentPackage}</strong>
                            </p>
                        </div>
                        <button onclick="deactivateEvent('${event.id}')" class="btn btn-sm" style="background: #fee2e2; color: #dc2626; padding: 2px 8px; font-size: 0.8rem; border:none;  cursor: pointer;">X</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function renderPackagesList(packages) {
            if (!packages || packages.length === 0) {
                packagesList.innerHTML = '<p class="text-sm">No hay eventos madre.</p>';
                return;
            }

            packagesList.innerHTML = packages.map(pkg => `
                <div class="package-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4>${pkg.package_name}</h4>
                            <div class="mt-2">
                                <p class="text-xs font-bold uppercase text-gray">Eventos Incluidos:</p>
                                <ul style="list-style: disc; margin-left: 1.5rem; font-size: 0.85rem;" class="mt-1">
                                    ${pkg.events && pkg.events.length > 0
                    ? pkg.events.map(e => `<li>${e.event_name}</li>`).join('')
                    : '<li class="text-gray">Sin eventos asignados</li>'}
                                </ul>
                            </div>
                        </div>
                        <button onclick="deactivatePackage('${pkg.id}')" class="btn btn-sm" style="background: #fee2e2; color: #dc2626; padding: 2px 8px; border:none; cursor: pointer; border-radius: 4px;">X</button>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // HANDLERS
        // ==========================================
        async function handlePackageSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            const data = {
                package_name: formData.get('package_name'),
                package_price: parseFloat(formData.get('package_price')),
                discount_percent: parseInt(formData.get('discount_percent')) || 0,
                description: formData.get('description')
            };

            try {
                await api.post('/packages', data);
                alert('‚úÖ Evento Madre creado');
                form.reset();
                loadPackages(); // Update list and select
            } catch (error) {
                console.error(error);
                alert('Error: ' + error.message);
            }
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const packageId = formData.get('package_id');

            if (!packageId) {
                alert('‚ö†Ô∏è Por favor selecciona un Evento Madre');
                return;
            }

            const data = {
                event_name: formData.get('event_name'),
                event_date: formData.get('event_date'),
                city: formData.get('city'),
                base_price: parseFloat(formData.get('base_price')) || 0,
                package_id: packageId // Send this to API
            };

            try {
                await api.post('/events', data);
                alert('‚úÖ Evento creado y asignado exitosamente');
                form.reset();
                // Refresh both lists to show the new event in the list AND inside the package
                loadInitialData();
            } catch (error) {
                console.error(error);
                alert('Error al crear evento: ' + error.message);
            }
        }

        // Global Deactivate functions
        window.deactivatePackage = async function (id) {
            if (!confirm('¬øDesactivar este paquete? Ya no saldr√° en ventas.')) return;
            try {
                await api.delete(`/packages/${id}`);
                loadPackages();
            } catch (error) { alert(error.message); }
        }

        window.deactivateEvent = async function (id) {
            if (!confirm('¬øDesactivar este evento?')) return;
            try {
                await api.delete(`/events/${id}`);
                loadEvents();
            } catch (error) { alert(error.message); }
        }
    </script>
</body>

</html>