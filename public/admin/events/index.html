<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Eventos - Summer Unified</title>
    <!-- Estilos Globales -->
    <link rel="stylesheet" href="/shared/css/variables.css">
    <link rel="stylesheet" href="/shared/css/global.css">
    <script src="/shared/js/api-client.js"></script>
    <style>
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
        }

        .event-card,
        .package-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .tag {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            font-size: 0.8rem;
            margin-right: 0.4rem;
            background: var(--primary-light);
            color: var(--primary);
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-area">
                    <h1>üéâ Gesti√≥n de Eventos</h1>
                </div>
                <div class="user-area">
                    <a href="/dashboard/main.html" class="btn btn-secondary">‚Üê Volver al Dashboard</a>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="admin-grid">
                <!-- Columna 1: Crear Paquetes (Eventos Madre) -->
                <section>
                    <div class="card">
                        <h2>üì¶ Nuevo "Evento Madre" (Paquete)</h2>
                        <p class="text-sm text-gray">Crea un paquete que agrupe varios eventos.</p>

                        <form id="packageForm" class="mt-4">
                            <div class="form-group">
                                <label>Nombre del Paquete</label>
                                <input type="text" name="package_name" required placeholder="Ej: Pack Fin de A√±o">
                            </div>
                            <div class="form-group">
                                <label>Precio (Bs)</label>
                                <input type="number" name="package_price" required placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label>Descuento (%)</label>
                                <input type="number" name="discount_percent" value="0" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>Descripci√≥n</label>
                                <textarea name="description" rows="2"></textarea>
                            </div>

                            <div class="form-group">
                                <label>Seleccionar Eventos Incluidos</label>
                                <div id="eventsSelection" class="checkbox-group">
                                    <!-- Se llenar√° din√°micamente -->
                                    <p class="text-sm">Cargando eventos...</p>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-full">Crear Paquete</button>
                        </form>
                    </div>

                    <div class="mt-8">
                        <h3>Paquetes Activos</h3>
                        <div id="packagesList" class="mt-4">
                            <!-- Lista de paquetes -->
                        </div>
                    </div>
                </section>

                <!-- Columna 2: Crear Eventos Individuales -->
                <section>
                    <div class="card">
                        <h2>üìÖ Nuevo Evento Individual</h2>
                        <p class="text-sm text-gray">Agrega eventos sueltos que componen los paquetes.</p>

                        <form id="eventForm" class="mt-4">
                            <div class="form-group">
                                <label>Nombre del Evento</label>
                                <input type="text" name="event_name" required placeholder="Ej: Fiesta de Bienvenida">
                            </div>
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" name="event_date" required>
                            </div>
                            <div class="form-group">
                                <label>Ciudad</label>
                                <select name="city" required>
                                    <option value="Tarija">Tarija</option>
                                    <option value="Santa Cruz">Santa Cruz</option>
                                    <option value="Cochabamba">Cochabamba</option>
                                    <option value="La Paz">La Paz</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Precio Individual Estimado</label>
                                <input type="number" name="base_price" placeholder="0.00">
                            </div>

                            <button type="submit" class="btn btn-secondary w-full">Crear Evento</button>
                        </form>
                    </div>

                    <div class="mt-8">
                        <h3>Eventos Disponibles</h3>
                        <div id="eventsList" class="mt-4">
                            <!-- Lista de eventos -->
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        const api = new APIClient();

        // Elementos DOM
        const eventsList = document.getElementById('eventsList');
        const packagesList = document.getElementById('packagesList');
        const eventsSelection = document.getElementById('eventsSelection');

        // Cargar datos al inicio
        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
            loadPackages();

            document.getElementById('packageForm').addEventListener('submit', handlePackageSubmit);
            document.getElementById('eventForm').addEventListener('submit', handleEventSubmit);
        });

        // ==========================================
        // CARGAR DATOS
        // ==========================================
        async function loadEvents() {
            try {
                // Sencillo fallback en caso de no existir ruta events directa
                const result = await api.get('/events').catch(() => []);
                const events = Array.isArray(result) ? result : [];

                renderEventsList(events);
                renderEventsSelection(events);
            } catch (error) {
                console.error('Error loading events:', error);
                eventsSelection.innerHTML = '<p class="text-error">Error cargando eventos</p>';
            }
        }

        async function loadPackages() {
            try {
                const packages = await api.get('/packages');
                renderPackagesList(packages);
            } catch (error) {
                console.error('Error loading packages:', error);
            }
        }

        // ==========================================
        // RENDERIZADO
        // ==========================================
        function renderEventsSelection(events) {
            if (!events || events.length === 0) {
                eventsSelection.innerHTML = '<p class="text-sm text-gray">No hay eventos disponibles</p>';
                return;
            }

            eventsSelection.innerHTML = events.map(event => `
                <div class="checkbox-item" style="margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="event_ids" value="${event.id}">
                        <span>${event.event_name} (${new Date(event.event_date).toLocaleDateString()}) - ${event.city}</span>
                    </label>
                </div>
            `).join('');
        }

        function renderEventsList(events) {
            if (!events || events.length === 0) {
                eventsList.innerHTML = '<p>No hay eventos registrados</p>';
                return;
            }

            eventsList.innerHTML = events.map(event => `
                <div class="event-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4>${event.event_name}</h4>
                            <p class="text-sm text-gray">
                                üìÖ ${new Date(event.event_date).toLocaleDateString()} | üìç ${event.city}
                            </p>
                            <p class="text-sm font-bold mt-1">Precio ref: Bs ${event.base_price || '0.00'}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderPackagesList(packages) {
            if (!packages || packages.length === 0) {
                packagesList.innerHTML = '<p>No hay paquetes activos</p>';
                return;
            }

            packagesList.innerHTML = packages.map(pkg => `
                <div class="package-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <h4>${pkg.package_name}</h4>
                                ${pkg.discount_percent > 0 ? `<span class="tag">-${pkg.discount_percent}% OFF</span>` : ''}
                            </div>
                            <h3 class="text-primary mt-1">Bs ${pkg.package_price}</h3>
                            <p class="text-sm text-gray mt-2">${pkg.description || 'Sin descripci√≥n'}</p>
                            
                            <div class="mt-3">
                                <p class="text-xs font-bold uppercase text-gray">Incluye:</p>
                                <ul style="list-style: disc; margin-left: 1.5rem; font-size: 0.9rem;" class="mt-1">
                                    ${pkg.events && pkg.events.length > 0
                    ? pkg.events.map(e => `<li>${e.event_name}</li>`).join('')
                    : '<li>Sin eventos asignados</li>'}
                                </ul>
                            </div>
                        </div>
                        <button onclick="deactivatePackage('${pkg.id}')" class="btn btn-sm" style="background: #fee2e2; color: #dc2626; cursor: pointer; border:none; padding: 5px 10px; border-radius: 4px;">Desactivar</button>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // HANDLERS
        // ==========================================
        async function handlePackageSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            // Obtener IDs de eventos seleccionados
            const selectedEvents = Array.from(form.querySelectorAll('input[name="event_ids"]:checked'))
                .map(cb => cb.value);

            const data = {
                package_name: formData.get('package_name'),
                package_price: parseFloat(formData.get('package_price')),
                discount_percent: parseInt(formData.get('discount_percent')) || 0,
                description: formData.get('description'),
                event_ids: selectedEvents
            };

            try {
                await api.post('/packages', data);
                alert('‚úÖ Paquete creado exitosamente');
                form.reset();
                loadPackages();
            } catch (error) {
                console.error(error);
                alert('Error al crear paquete: ' + error.message);
            }
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            const data = {
                event_name: formData.get('event_name'),
                event_date: formData.get('event_date'),
                city: formData.get('city'),
                base_price: parseFloat(formData.get('base_price')) || 0,
                event_slug: formData.get('event_name').toLowerCase().replace(/ /g, '-').replace(/[^\w-]/g, ''),
                venue: 'Por definir', // Default
                image_url: null,
                is_active: true
            };

            try {
                await api.post('/events', data);
                alert('‚úÖ Evento creado exitosamente');
                form.reset();
                loadEvents();
            } catch (error) {
                console.error(error);
                alert('Error al crear evento: ' + error.message);
            }
        }

        // Hacer global
        window.deactivatePackage = async function (id) {
            if (!confirm('¬øSeguro que quieres desactivar este paquete?')) return;
            try {
                await api.delete(`/packages/${id}`);
                loadPackages();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>

</html>