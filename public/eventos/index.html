<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Eventos - Summer Festival</title>
    <link rel="stylesheet" href="/shared/css/global.css">
    <link rel="stylesheet" href="/shared/css/variables.css">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-light);
        }

        .page-title {
            color: var(--primary);
            margin: 0;
        }

        .btn-new-event {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform var(--transition-fast);
        }

        .btn-new-event:hover {
            transform: translateY(-2px);
        }

        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .event-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-lg);
            border: 2px solid transparent;
            transition: all var(--transition-fast);
        }

        .event-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .event-card.inactive {
            opacity: 0.6;
            background: var(--bg-light);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .event-title {
            font-size: 1.2rem;
            font-weight: var(--font-weight-bold);
            color: var(--text-dark);
            margin: 0;
            flex-grow: 1;
        }

        .event-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: var(--font-weight-bold);
            text-transform: uppercase;
        }

        .event-status.active {
            background: #e8f5e9;
            color: var(--success-dark);
        }

        .event-status.inactive {
            background: #ffebee;
            color: #c62828;
        }

        .event-details {
            margin-bottom: 16px;
        }

        .event-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .event-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-edit {
            background: var(--info);
            color: white;
        }

        .btn-toggle {
            background: var(--warning);
            color: white;
        }

        .btn-delete {
            background: var(--error);
            color: white;
        }

        .btn-action:hover {
            transform: scale(1.05);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-light);
        }

        .modal-title {
            margin: 0;
            color: var(--primary);
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: var(--font-weight-bold);
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color var(--transition-fast);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-save {
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: var(--font-weight-bold);
            cursor: pointer;
        }

        .btn-cancel {
            background: var(--bg-light);
            color: var(--text-dark);
            padding: 12px 24px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: var(--font-weight-bold);
            cursor: pointer;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #e8f5e9;
            border-color: var(--success);
            color: var(--success-dark);
        }

        .alert-error {
            background: #ffebee;
            border-color: var(--error);
            color: #c62828;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .no-events {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .no-events h3 {
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .page-header {
                flex-direction: column;
                gap: 20px;
                align-items: stretch;
                text-align: center;
            }

            .events-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
                margin: 20px;
            }

            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="page-header">
            <h1 class="page-title">üéâ Gesti√≥n de Eventos</h1>
            <button class="btn-new-event" onclick="openCreateModal()">
                ‚ûï Nuevo Evento
            </button>
        </div>

        <!-- Navegaci√≥n de regreso -->
        <div style="margin-bottom: 20px;">
            <a href="/dashboard/main.html" style="color: var(--primary); text-decoration: none;">
                ‚Üê Volver al Dashboard
            </a>
        </div>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Lista de Eventos -->
        <div id="eventsContainer">
            <div class="loading">
                <p>üîÑ Cargando eventos...</p>
            </div>
        </div>

        <!-- Modal para Crear/Editar Evento -->
        <div id="eventModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="modalTitle">Nuevo Evento</h2>
                    <button class="btn-close" onclick="closeModal()">&times;</button>
                </div>

                <form id="eventForm">
                    <div class="form-group">
                        <label for="eventName">Nombre del Evento *</label>
                        <input type="text" id="eventName" class="form-control" required
                               placeholder="ej: A√±o Nuevo 2026 - Tarija">
                    </div>

                    <div class="form-group">
                        <label for="eventDate">Fecha del Evento *</label>
                        <input type="date" id="eventDate" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="eventType">Tipo de Evento</label>
                        <select id="eventType" class="form-control">
                            <option value="">Seleccionar tipo</option>
                            <option value="fiesta">Fiesta</option>
                            <option value="concierto">Concierto</option>
                            <option value="festival">Festival</option>
                            <option value="evento-corporativo">Evento Corporativo</option>
                            <option value="celebracion">Celebraci√≥n</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="eventCity">Ciudad *</label>
                        <select id="eventCity" class="form-control" required>
                            <option value="">Seleccionar ciudad</option>
                            <option value="Tarija">Tarija</option>
                            <option value="Santa Cruz">Santa Cruz</option>
                            <option value="Cochabamba">Cochabamba</option>
                            <option value="La Paz">La Paz</option>
                            <option value="Sucre">Sucre</option>
                            <option value="Potos√≠">Potos√≠</option>
                            <option value="Oruro">Oruro</option>
                            <option value="Beni">Beni</option>
                            <option value="Pando">Pando</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="venueName">Nombre del Lugar</label>
                        <input type="text" id="venueName" class="form-control"
                               placeholder="ej: Club Social, Hotel Libertador">
                    </div>

                    <div class="form-group">
                        <label for="capacity">Capacidad</label>
                        <input type="number" id="capacity" class="form-control" min="1"
                               placeholder="ej: 500">
                    </div>

                    <div class="form-group">
                        <label for="ticketPrice">Precio del Ticket (Bs.) *</label>
                        <input type="number" id="ticketPrice" class="form-control" 
                               min="0" step="0.01" required
                               placeholder="ej: 200.00">
                    </div>

                    <div class="form-group">
                        <label for="eventStatus">Estado</label>
                        <select id="eventStatus" class="form-control">
                            <option value="activo">Activo</option>
                            <option value="inactivo">Inactivo</option>
                            <option value="agotado">Agotado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeModal()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-save" id="btnSave">
                            üíæ Guardar Evento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/shared/js/api-client.js"></script>
    <script>
        // Cliente API
        const api = new APIClient();
        
        // Estado de la aplicaci√≥n
        let events = [];
        let editingEventId = null;

        // Elementos del DOM
        const eventsContainer = document.getElementById('eventsContainer');
        const eventModal = document.getElementById('eventModal');
        const eventForm = document.getElementById('eventForm');
        const modalTitle = document.getElementById('modalTitle');
        const btnSave = document.getElementById('btnSave');
        const alertContainer = document.getElementById('alertContainer');

        // ========================================================================
        // FUNCIONES DE CARGA DE DATOS
        // ========================================================================

        // Cargar eventos
        async function loadEvents() {
            try {
                console.log('üîÑ Cargando eventos...');
                const response = await api.get('/events');
                events = response.data || response;
                
                renderEvents();
                console.log('‚úÖ Eventos cargados:', events.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando eventos:', error);
                showAlert(`Error cargando eventos: ${error.message}`, 'error');
                eventsContainer.innerHTML = '<div class="no-events"><h3>Error cargando eventos</h3><p>Intenta recargar la p√°gina</p></div>';
            }
        }

        // Renderizar lista de eventos
        function renderEvents() {
            if (!events || events.length === 0) {
                eventsContainer.innerHTML = `
                    <div class="no-events">
                        <h3>No hay eventos creados</h3>
                        <p>Crea tu primer evento para comenzar a recibir registros de ventas</p>
                    </div>
                `;
                return;
            }

            const eventsHTML = events.map(event => `
                <div class="event-card ${event.status !== 'activo' ? 'inactive' : ''}">
                    <div class="event-header">
                        <h3 class="event-title">${event.event_name}</h3>
                        <span class="event-status ${event.status === 'activo' ? 'active' : 'inactive'}">
                            ${event.status || 'activo'}
                        </span>
                    </div>
                    
                    <div class="event-details">
                        <div class="event-detail">
                            <span>üìÖ</span>
                            <span>${formatDate(event.event_date)}</span>
                        </div>
                        <div class="event-detail">
                            <span>üìç</span>
                            <span>${event.city}</span>
                        </div>
                        ${event.venue_name ? `
                        <div class="event-detail">
                            <span>üè¢</span>
                            <span>${event.venue_name}</span>
                        </div>
                        ` : ''}
                        <div class="event-detail">
                            <span>üé´</span>
                            <span>Bs. ${parseFloat(event.ticket_price || 0).toLocaleString()}</span>
                        </div>
                        ${event.capacity ? `
                        <div class="event-detail">
                            <span>üë•</span>
                            <span>${event.capacity} personas</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="event-actions">
                        <button class="btn-action btn-edit" onclick="editEvent(${event.id})">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="btn-action btn-toggle" onclick="toggleEventStatus(${event.id})">
                            ${event.status === 'activo' ? '‚è∏Ô∏è Desactivar' : '‚ñ∂Ô∏è Activar'}
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteEvent(${event.id})">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `).join('');

            eventsContainer.innerHTML = `<div class="events-grid">${eventsHTML}</div>`;
        }

        // ========================================================================
        // FUNCIONES DEL MODAL
        // ========================================================================

        // Abrir modal para crear evento
        function openCreateModal() {
            editingEventId = null;
            modalTitle.textContent = 'Nuevo Evento';
            btnSave.textContent = 'üíæ Crear Evento';
            eventForm.reset();
            
            // Establecer fecha por defecto (hoy + 1 d√≠a)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('eventDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('eventStatus').value = 'activo';
            
            eventModal.classList.add('active');
        }

        // Abrir modal para editar evento
        function editEvent(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            editingEventId = eventId;
            modalTitle.textContent = 'Editar Evento';
            btnSave.textContent = 'üíæ Actualizar Evento';

            // Llenar formulario con datos del evento
            document.getElementById('eventName').value = event.event_name || '';
            document.getElementById('eventDate').value = event.event_date || '';
            document.getElementById('eventType').value = event.event_type || '';
            document.getElementById('eventCity').value = event.city || '';
            document.getElementById('venueName').value = event.venue_name || '';
            document.getElementById('capacity').value = event.capacity || '';
            document.getElementById('ticketPrice').value = event.ticket_price || '';
            document.getElementById('eventStatus').value = event.status || 'activo';

            eventModal.classList.add('active');
        }

        // Cerrar modal
        function closeModal() {
            eventModal.classList.remove('active');
            eventForm.reset();
            editingEventId = null;
        }

        // ========================================================================
        // FUNCIONES DE CRUD
        // ========================================================================

        // Crear o actualizar evento
        async function saveEvent(eventData) {
            try {
                if (editingEventId) {
                    // Actualizar evento existente
                    await api.put(`/events/${editingEventId}`, eventData);
                    showAlert('‚úÖ Evento actualizado exitosamente', 'success');
                } else {
                    // Crear nuevo evento
                    await api.post('/events', eventData);
                    showAlert('‚úÖ Evento creado exitosamente', 'success');
                }

                closeModal();
                loadEvents(); // Recargar lista

            } catch (error) {
                console.error('‚ùå Error guardando evento:', error);
                showAlert(`Error guardando evento: ${error.message}`, 'error');
            }
        }

        // Alternar estado del evento
        async function toggleEventStatus(eventId) {
            try {
                const event = events.find(e => e.id === eventId);
                const newStatus = event.status === 'activo' ? 'inactivo' : 'activo';
                
                await api.put(`/events/${eventId}`, { status: newStatus });
                showAlert(`‚úÖ Evento ${newStatus === 'activo' ? 'activado' : 'desactivado'} correctamente`, 'success');
                
                loadEvents(); // Recargar lista

            } catch (error) {
                console.error('‚ùå Error cambiando estado:', error);
                showAlert(`Error cambiando estado: ${error.message}`, 'error');
            }
        }

        // Eliminar evento
        async function deleteEvent(eventId) {
            const event = events.find(e => e.id === eventId);
            
            if (!confirm(`¬øEst√°s seguro de eliminar el evento "${event.event_name}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }

            try {
                await api.delete(`/events/${eventId}`);
                showAlert('‚úÖ Evento eliminado correctamente', 'success');
                
                loadEvents(); // Recargar lista

            } catch (error) {
                console.error('‚ùå Error eliminando evento:', error);
                showAlert(`Error eliminando evento: ${error.message}`, 'error');
            }
        }

        // ========================================================================
        // FUNCIONES DE UI
        // ========================================================================

        // Mostrar alerta
        function showAlert(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            const alertHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
            
            alertContainer.innerHTML = alertHTML;
            
            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // Formatear fecha
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // ========================================================================
        // EVENT LISTENERS
        // ========================================================================

        // Env√≠o del formulario
        eventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                event_name: document.getElementById('eventName').value,
                event_date: document.getElementById('eventDate').value,
                event_type: document.getElementById('eventType').value,
                city: document.getElementById('eventCity').value,
                venue_name: document.getElementById('venueName').value,
                capacity: parseInt(document.getElementById('capacity').value) || null,
                ticket_price: parseFloat(document.getElementById('ticketPrice').value),
                status: document.getElementById('eventStatus').value
            };

            // Generar slug autom√°ticamente
            formData.event_slug = generateSlug(formData.event_name);

            btnSave.disabled = true;
            btnSave.textContent = 'üîÑ Guardando...';

            await saveEvent(formData);

            btnSave.disabled = false;
            btnSave.textContent = editingEventId ? 'üíæ Actualizar Evento' : 'üíæ Crear Evento';
        });

        // Generar slug para el evento
        function generateSlug(eventName) {
            return eventName
                .toLowerCase()
                .replace(/[√°√§√†√¢√£]/g, 'a')
                .replace(/[√©√´√®√™]/g, 'e')
                .replace(/[√≠√Ø√¨√Æ]/g, 'i')
                .replace(/[√≥√∂√≤√¥√µ]/g, 'o')
                .replace(/[√∫√º√π√ª]/g, 'u')
                .replace(/[√±]/g, 'n')
                .replace(/[^a-z0-9\s-]/g, '')
                .trim()
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');
        }

        // Cerrar modal con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Cerrar modal al hacer clic fuera
        eventModal.addEventListener('click', (e) => {
            if (e.target === eventModal) {
                closeModal();
            }
        });

        // ========================================================================
        // INICIALIZACI√ìN
        // ========================================================================

        // Cargar eventos al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Iniciando gesti√≥n de eventos');
            loadEvents();
        });
    </script>
</body>
</html>